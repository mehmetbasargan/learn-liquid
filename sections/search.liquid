{% comment %}
  This section is used in the search template to render search results for
  products, articles, and pages.

  https://shopify.dev/docs/storefronts/themes/architecture/templates/search
{% endcomment %}

<div class="container py-20">
  <form action="{{ routes.search_url }}" method="get" role="search" class="flex items-center gap-2">
    <input
      id="search-input"
      type="search"
      size="50"
      name="q"
      value="{{ search.terms | escape }}"
      placeholder="{{ 'search.placeholder' | t }}"
      class="border border-gray-300 rounded px-4 py-2 h-16 w-full focus:outline-none focus:ring-1 focus:ring-secondary"
    >
    <button
      type="submit"
      class="h-[64px] w-[64px] border border-gray-300 rounded flex items-center justify-center hover:bg-secondary text-primary hover:text-white cursor-pointer"
    >
      {% render 'icon-search' %}
    </button>
  </form>

  {% if search.performed %}
    {% if search.results_count == 0 %}
      <p>{{ 'search.no_results_html' | t: terms: search.terms }}</p>
    {% else %}
      <div class="pt-10 w-full text-center">
        <p class="text-xl">{{ 'search.results_for_html' | t: terms: search.terms, count: search.results_count }}</p>
      </div>

      <div class="search-results py-10">
        {% paginate search.results by 20 %}
          {% # Search result items may be an article, a page, or a product. %}
          <div id="search-results" class="grid sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 w-full">
            {% for result in search.results %}
              {% render 'product-card', product: result %}
            {% endfor %}
          </div>
          {{ paginate | default_pagination }}
        {% endpaginate %}
      </div>
    {% endif %}
  {% endif %}
</div>

{% stylesheet %}
{% endstylesheet %}

<script>
  const searchInput = document.querySelector('#search-input');
  const resultsContainer = document.querySelector('#search-results');

  searchInput.addEventListener('input', (e) => {
    const searchTerm = e.target.value.trim();

    // 1. Kutu boşsa sonuçları anında temizle
    if (searchTerm.length === 0) {
      resultsContainer.innerHTML = '';
      return;
    }

    // 2. En az 3 karakter olunca aramaya başla (Performans için)
    if (searchTerm.length > 2) {
      // Shopify Predictive Search API'sini kullanıyoruz
      fetch(`/search/suggest.json?q=${searchTerm}&resources[type]=product&resources[limit]=4`)
        .then((response) => response.json())
        .then((suggestions) => {
          const products = suggestions.data.products;

          if (products.length > 0) {
            renderResults(products);
          } else {
            resultsContainer.innerHTML = `<p>{{ 'search.no_results_html' | t }}</p>`;
          }
        });
    }
  });

  function renderResults(products) {
    resultsContainer.innerHTML = products
      .map(
        (product) => `
    <div class="search-item">
      <a href="${product.url}">
        <img src="${product.image}" alt="${product.title}" class="w-12 h-12 object-cover">
        <span>${product.title}</span>
      </a>
    </div>
  `
      )
      .join('');
  }
</script>

{% schema %}
{
  "name": "t:general.search",
  "settings": []
}
{% endschema %}
