<div class="container py-20">
  {% comment %} Arama Formu {% endcomment %}
  <form
    action="{{ routes.search_url }}"
    method="get"
    role="search"
    class="flex items-center gap-2 max-w-3xl mx-auto mb-10"
  >
    <input type="hidden" name="type" value="product">
    <div class="relative w-full">
      <input
        id="search-input"
        type="search"
        name="q"
        value="{{ search.terms | escape }}"
        placeholder="{{ 'general.search.placeholder' | t }}"
        class="border border-line rounded px-4 py-2 h-16 w-full focus:outline-none focus:ring-1 focus:ring-secondary font-inter"
        autocomplete="off"
      >
    </div>
    <button
      type="submit"
      class="h-[64px] w-[64px] bg-secondary text-white rounded flex items-center justify-center hover:bg-primary transition-colors shrink-0"
    >
      {% render 'icon-search', class: 'w-6 h-6' %}
    </button>
  </form>

  {% comment %} Sabit Başlık Alanı {% endcomment %}
  <div
    id="search-header-wrapper"
    class="mb-8 border-b border-line pb-4 {% unless search.performed %}hidden{% endunless %}"
  >
    <h6 id="dynamic-search-title" class="font-josefin text-2xl text-primary uppercase tracking-widest leading-relaxed">
      {% if search.performed %}
        {{ 'general.search.results_with_count' | t: terms: search.terms, count: search.results_count }}
      {% endif %}
    </h6>
  </div>

  {% comment %} Sonuç Alanı {% endcomment %}
  <div id="search-results-container">
    <div id="search-results" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6 w-full">
      {% if search.performed %}
        {% for result in search.results %}
          {% if result.object_type == 'product' %}
            {% render 'product-card', product: result %}
          {% endif %}
        {% endfor %}
      {% endif %}
    </div>

    <div id="search-empty-message" class="hidden text-center py-20 font-josefin text-lg text-gray-500">
      {{ 'general.search.no_results' | t }}
    </div>
  </div>
</div>

<script>
  const searchInput = document.querySelector('#search-input');
  const resultsContainer = document.querySelector('#search-results');
  const searchHeaderWrapper = document.querySelector('#search-header-wrapper');
  const dynamicTitle = document.querySelector('#dynamic-search-title');
  const emptyMessage = document.querySelector('#search-empty-message');

  // Currency formatter (automatically formats based on store settings - TL/Dollar etc.)
  const formatMoney = (cents) => {
    return (cents / 100).toLocaleString('{{ shop.locale }}', {
      style: 'currency',
      currency: '{{ cart.currency.iso_code }}',
    });
  };

  /** * Check if translation file exists.
   * If no translation, manually write "Search Results".
   */
  const rawSearchLabel = "{{ 'general.search.search_results' | t }}";
  const searchLabel = rawSearchLabel.includes('search_results') ? 'Search Results' : rawSearchLabel;

  searchInput.addEventListener('input', function (e) {
    const searchTerm = e.target.value.trim();

    if (searchTerm.length <= 2) {
      if (!window.location.search.includes('q=')) {
        searchHeaderWrapper.classList.add('hidden');
        resultsContainer.innerHTML = '';
      }
      return;
    }

    // Shopify Predictive Search API
    fetch(
      `${window.Shopify.routes.root}search/suggest.json?q=${encodeURIComponent(
        searchTerm
      )}&resources[type]=product,article&resources[limit]=12`
    )
      .then((response) => response.json()) // Noktalı virgülü kaldırdık, zincir devam ediyor
      .then((data) => {
        // Ürünleri ve Makaleleri (Blogları) güvenli şekilde alıyoruz
        const products = data.resources?.results?.products || [];
        const articles = data.resources?.results?.articles || [];
        const allResults = [...products, ...articles];

        const resultCount = allResults.length;

        searchHeaderWrapper.classList.remove('hidden');
        dynamicTitle.innerText = `${searchLabel}: "${searchTerm}" (${resultCount})`;

        if (resultCount > 0) {
          emptyMessage.classList.add('hidden');
          resultsContainer.classList.remove('hidden');
          renderResults(allResults);
        } else {
          resultsContainer.innerHTML = '';
          emptyMessage.classList.remove('hidden');
        }
      })
      .catch((err) => console.error('Search Error:', err));
  });

  // HTML structure matches product-card.liquid file exactly
  function renderResults(results) {
    resultsContainer.innerHTML = results
      .map((item) => {
        // 1. Önce bu bir Blog yazısı mı kontrol edelim
        // Shopify API blog yazıları için genelde 'article' tipini döndürür veya URL'de /blogs/ geçer
        const isArticle = item.url.includes('/blogs/') || item.object_type === 'article';

        // 2. Görsel Ayarları
        const mainImage = item.featured_image ? item.featured_image.url : item.image || '';
        const hoverImage = !isArticle && item.images && item.images.length > 1 ? item.images[1].url : null;

        // 3. Ürün Bilgileri (Sadece Ürünse hesapla, yoksa hata verir)
        let priceHtml = '';
        let actionButton = '';

        if (!isArticle) {
          // ÜRÜN İÇİN HESAPLAMALAR
          const price = formatMoney(item.price);
          const isOnSale = item.compare_at_price > item.price;
          const comparePrice = isOnSale ? formatMoney(item.compare_at_price) : '';

          priceHtml = `
          <div class="mt-2 flex items-center gap-2">
            ${isOnSale ? `<span class="text-gray-400 line-through text-[13px]">${comparePrice}</span>` : ''}
            <span class="text-primary text-[14px] font-medium">${price}</span>
          </div>
        `;

          actionButton = `
          <div class="absolute inset-x-0 bottom-0 translate-y-full group-hover:translate-y-0 transition-transform duration-300 hidden md:block">
            <a href="${item.url}" class="w-full bg-primary text-white py-3 text-[13px] uppercase tracking-[0.2em] block text-center hover:bg-secondary transition-colors">
              {{ 'general.view_product' | t }}
            </a>
          </div>
        `;
        } else {
          // BLOG İÇİN BUTON (View Product yerine Read More)
          actionButton = `
          <div class="absolute inset-x-0 bottom-0 translate-y-full group-hover:translate-y-0 transition-transform duration-300 hidden md:block">
            <a href="${item.url}" class="w-full bg-black text-white py-3 text-[13px] uppercase tracking-[0.2em] block text-center hover:bg-secondary transition-colors">
              Read Article
            </a>
          </div>
        `;

          priceHtml = `
          <div class="mt-2">
            <span class="text-secondary text-[12px] font-medium uppercase tracking-wider">Journal / Article</span>
          </div>
        `;
        }

        return `
      <div class="group flex flex-col h-full bg-white overflow-hidden relative animate-fadeIn border border-transparent hover:border-gray-50 transition-all">
        <div class="relative aspect-[3/4] overflow-hidden bg-custombg">
          ${
            isArticle
              ? `<span class="absolute top-3 left-3 z-10 bg-black text-white font-bold text-[10px] px-2 py-1 tracking-widest uppercase italic shadow-sm">Journal</span>`
              : ''
          }
          
          <a href="${item.url}" class="block h-full w-full">
            <img src="${mainImage}" alt="${
          item.title
        }" class="w-full h-full object-cover transition-opacity duration-700 ${
          hoverImage ? 'group-hover:opacity-0' : ''
        }" loading="lazy">
            ${
              hoverImage
                ? `<img src="${hoverImage}" class="w-full h-full object-cover absolute inset-0 opacity-0 group-hover:opacity-100 transition-opacity duration-700">`
                : ''
            }
          </a>

          ${actionButton}
        </div>

        <div class="pt-4 pb-2 flex flex-col items-center px-3">
          <a href="${
            item.url
          }" class="text-primary font-light text-[14px] hover:text-secondary transition-colors uppercase text-center line-clamp-2 min-h-[40px]">
            ${item.title}
          </a>
          ${priceHtml}
        </div>
      </div>
    `;
      })
      .join('');
  }
</script>

<style>
  .animate-fadeIn {
    animation: fadeIn 0.5s ease-out forwards;
  }
  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
</style>
<style>
  .animate-fadeIn {
    animation: fadeIn 0.4s ease-out forwards;
  }
  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(8px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
</style>

<style>
  .animate-fadeIn {
    animation: fadeIn 0.5s ease forwards;
  }
  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
</style>
